<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mini-WTD ¬∑ Audit RGAA (d√©mo)</title>

  <meta name="description" content="Audit RGAA simplifi√© pour les pages Mini-WTD : titres, textes alternatifs, liens, labels et rep√®res de structure.">
  <meta name="author" content="Patrick Billy">
  <meta name="theme-color" content="#0b8457">

  <link rel="stylesheet" href="assets/css/rgaa-accessible.css">
  <link rel="stylesheet" href="assets/css/style.css">

  <style>
    .badge {
      display:inline-block;
      padding:0.2rem 0.6rem;
      border-radius:999px;
      font-size:0.85rem;
      font-weight:600;
    }
    .badge-ok {
      background:#0b8457;
      color:#fff;
    }
    .badge-warn {
      background:#d9822b;
      color:#fff;
    }
    .badge-err {
      background:#c53030;
      color:#fff;
    }
    .results-summary {
      display:flex;
      flex-wrap:wrap;
      gap:1rem;
      margin-top:1rem;
    }
    .results-summary div {
      padding:0.6rem 1rem;
      border-radius:8px;
      font-weight:600;
    }
    .results-ok    { background:#0b845714; color:#0b8457; border:1px solid #0b8457; }
    .results-warn  { background:#d9822b14; color:#d9822b; border:1px solid #d9822b; }
    .results-err   { background:#c5303014; color:#c53030; border:1px solid #c53030; }

    table.audit {
      width:100%;
      border-collapse:collapse;
      margin-top:1rem;
    }
    table.audit th,
    table.audit td {
      border:1px solid #ddd;
      padding:0.6rem 0.8rem;
      vertical-align:top;
    }
    table.audit th {
      background:#f5f5f5;
      text-align:left;
    }
    table.audit tr:nth-child(even) td {
      background:#fafafa;
    }

    .small {
      font-size:0.85rem;
      color:#666;
    }
  </style>
</head>

<body>
  <a class="skiplink" href="#main">Aller directement au contenu</a>

  <header class="site-header" role="banner">
    <div class="container header-inner">
      <a href="index.html" class="brand">
        <img src="assets/img/logo-mini-wtd.png" alt="Logo Mini-WTD" height="48">
      </a>
      <nav class="nav" aria-label="Navigation principale">
        <a href="index.html">Accueil</a>
        <a href="presentation.html">Pr√©sentation</a>
        <a href="demo-accessibilite.html">D√©mo accessibilit√©</a>
        <a href="demo-accessibilite-present.html">Mode Pr√©sentation</a>
        <a href="rgaa.html" aria-current="page">Audit RGAA</a>
        <a href="assistant.html">Assistant IA</a>
      </nav>
    </div>
  </header>

  <main id="main" class="container" tabindex="-1" role="main" aria-labelledby="page-title">
    <header class="card" style="margin-top:1rem">
      <h1 id="page-title">üîé Audit RGAA (d√©mo Mini-WTD)</h1>
      <p class="muted">
        Outil p√©dagogique pour montrer comment analyser rapidement une page :
        titres, images, liens, formulaires et rep√®res de structure.
      </p>
      <p class="small">
        <strong>Important :</strong> cet audit est une <strong>d√©mo simplifi√©e</strong>, il ne remplace pas
        un audit RGAA complet r√©alis√© par un¬∑e sp√©cialiste.
      </p>
    </header>

    <!-- Choix de la page √† analyser -->
    <section class="card" aria-labelledby="section-choix">
      <h2 id="section-choix">1. Choisir une page Mini-WTD √† analyser</h2>

      <form id="audit-form" class="form-grid" onsubmit="event.preventDefault(); runAudit();">
        <label for="page-select"><strong>Page √† auditer</strong></label>
        <select id="page-select" name="page">
          <option value="index.html">Accueil (index.html)</option>
          <option value="presentation.html">Pr√©sentation</option>
          <option value="demo-accessibilite.html">D√©mo accessibilit√©</option>
          <option value="demo-accessibilite-present.html">Mode Pr√©sentation</option>
          <option value="rgaa.html" selected>Audit RGAA (cette page)</option>
          <option value="assistant.html">Assistant IA</option>
        </select>

        <button class="btn btn--primary" type="submit" style="margin-top:1rem;">
          Lancer l‚Äôanalyse
        </button>
      </form>

      <p class="small">
        Astuce en atelier : faites choisir une page aux participant¬∑es, lancez l‚Äôaudit,
        puis discutez ensemble de chaque r√®gle (OK / √† v√©rifier / bloquante).
      </p>
    </section>

    <!-- R√©sultats -->
    <section class="card" aria-labelledby="section-resultats">
      <h2 id="section-resultats">2. R√©sultats de l‚Äôanalyse</h2>

      <p id="audit-target" class="muted small">
        Aucune analyse lanc√©e pour l‚Äôinstant.
      </p>

      <div class="results-summary" aria-live="polite">
        <div class="results-ok">OK : <span id="count-ok">0</span></div>
        <div class="results-warn">√Ä v√©rifier : <span id="count-warn">0</span></div>
        <div class="results-err">Bloquant : <span id="count-err">0</span></div>
      </div>

      <table class="audit" aria-describedby="audit-target">
        <thead>
          <tr>
            <th scope="col">Crit√®re (d√©mo)</th>
            <th scope="col">R√©sultat</th>
            <th scope="col">D√©tail</th>
          </tr>
        </thead>
        <tbody id="audit-body">
          <!-- Lignes remplies en JS -->
        </tbody>
      </table>
    </section>

    <section class="card" aria-labelledby="section-usage">
      <h2 id="section-usage">3. Comment utiliser cet outil en formation</h2>
      <ul>
        <li>Choisir une page Mini-WTD (ou une version modifi√©e par les stagiaires).</li>
        <li>Lancer l‚Äôaudit, lire chaque crit√®re et laisser les participant¬∑es r√©agir.</li>
        <li>Ouvrir la page dans un autre onglet, montrer le code HTML correspondant.</li>
        <li>Modifier le code (par ex. ajouter un <code>alt</code>, un <code>label</code>, un <code>role</code>) et relancer l‚Äôaudit.</li>
      </ul>
      <p class="small">
        Objectif : rendre le RGAA moins th√©orique, plus concret, en montrant l‚Äôimpact direct
        d‚Äôun titre ou d‚Äôun texte alternatif sur l‚Äôanalyse automatique.
      </p>
    </section>
  </main>

  <footer class="container footer" role="contentinfo">
    <small>¬© 2025 Mini-WTD ‚Äî Audit RGAA (d√©mo) ¬∑ Patrick Billy</small>
  </footer>

  <script>
    async function runAudit() {
      const select = document.getElementById('page-select');
      const page   = select.value;
      const target = document.getElementById('audit-target');
      const tbody  = document.getElementById('audit-body');

      target.textContent = 'Analyse en cours pour : ' + page + '‚Ä¶';

      let htmlText = '';
      try {
        const resp = await fetch(page, { cache: 'no-store' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        htmlText = await resp.text();
      } catch (e) {
        target.textContent = 'Impossible de charger la page ¬´ ' + page + ' ¬ª. (' + e.message + ')';
        tbody.innerHTML = '';
        return;
      }

      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlText, 'text/html');

      // Compteurs
      let ok = 0, warn = 0, err = 0;
      const rows = [];

      function addRow(label, status, detail) {
        let badgeClass, badgeText;
        if (status === 'ok') {
          ok++; badgeClass = 'badge badge-ok'; badgeText = 'OK';
        } else if (status === 'warn') {
          warn++; badgeClass = 'badge badge-warn'; badgeText = '√Ä v√©rifier';
        } else {
          err++; badgeClass = 'badge badge-err'; badgeText = 'Bloquant';
        }
        rows.push(
          '<tr>' +
            '<td>' + label + '</td>' +
            '<td><span class="' + badgeClass + '">' + badgeText + '</span></td>' +
            '<td>' + detail + '</td>' +
          '</tr>'
        );
      }

      // 1. Titre de page
      const title = doc.querySelector('title');
      if (title && title.textContent.trim().length > 0) {
        addRow(
          'Titre de page',
          'ok',
          'Titre pr√©sent : <code>' + escapeHtml(title.textContent.trim()) + '</code>.'
        );
      } else {
        addRow(
          'Titre de page',
          'err',
          'Aucun <code>&lt;title&gt;</code> d√©tect√©. Chaque page doit avoir un titre explicite.'
        );
      }

      // 2. Pr√©sence d‚Äôun H1
      const h1 = doc.querySelector('h1');
      if (h1) {
        addRow(
          'Titre de niveau 1 (H1)',
          'ok',
          'Un <code>&lt;h1&gt;</code> est pr√©sent : ¬´ ' + escapeHtml(h1.textContent.trim()) + ' ¬ª.'
        );
      } else {
        addRow(
          'Titre de niveau 1 (H1)',
          'err',
          'Aucun <code>&lt;h1&gt;</code> d√©tect√©. Il est recommand√© d‚Äôavoir un titre principal par page.'
        );
      }

      // 3. Images sans alt
      const imgs = Array.from(doc.querySelectorAll('img'));
      const imgsSansAlt = imgs.filter(img => !img.hasAttribute('alt') || img.getAttribute('alt').trim() === '');
      if (imgs.length === 0) {
        addRow(
          'Images / textes alternatifs',
          'warn',
          'Aucune image dans la page. Rien √† v√©rifier ici, mais pensez aux textes alternatifs si vous en ajoutez.'
        );
      } else if (imgsSansAlt.length === 0) {
        addRow(
          'Images / textes alternatifs',
          'ok',
          'Toutes les ' + imgs.length + ' images poss√®dent un attribut <code>alt</code> renseign√©.'
        );
      } else {
        addRow(
          'Images / textes alternatifs',
          'err',
          imgsSansAlt.length + ' image(s) sans <code>alt</code> sur ' + imgs.length +
          '. Exemple : <code>' + escapeHtml(imgsSansAlt[0].outerHTML) + '</code>.'
        );
      }

      // 4. Liens sans texte visible
      const links = Array.from(doc.querySelectorAll('a'));
      const emptyLinks = links.filter(a => a.textContent.trim().length === 0);
      if (links.length === 0) {
        addRow(
          'Liens / intitul√©s',
          'warn',
          'Aucun lien trouv√© dans la page.'
        );
      } else if (emptyLinks.length === 0) {
        addRow(
          'Liens / intitul√©s',
          'ok',
          'Tous les liens poss√®dent un intitul√© visible.'
        );
      } else {
        addRow(
          'Liens / intitul√©s',
          'err',
          emptyLinks.length + ' lien(s) sans texte visible. Exemple : <code>' +
          escapeHtml(emptyLinks[0].outerHTML) + '</code>.'
        );
      }

      // 5. Champs de formulaire sans label
      const controls = Array.from(doc.querySelectorAll('input, select, textarea'))
        .filter(el => el.type !== 'hidden');
      const unlabelled = controls.filter(c => !hasLabel(doc, c));
      if (controls.length === 0) {
        addRow(
          'Formulaires / labels',
          'warn',
          'Aucun champ de formulaire d√©tect√©.'
        );
      } else if (unlabelled.length === 0) {
        addRow(
          'Formulaires / labels',
          'ok',
          'Tous les ' + controls.length + ' champs de formulaire ont un label associ√©.'
        );
      } else {
        addRow(
          'Formulaires / labels',
          'err',
          unlabelled.length + ' champ(s) sans label sur ' + controls.length +
          '. Exemple : <code>' + escapeHtml(unlabelled[0].outerHTML) + '</code>.'
        );
      }

      // 6. Rep√®res de structure
      const hasHeader = !!doc.querySelector('header,[role="banner"]');
      const hasNav    = !!doc.querySelector('nav,[role="navigation"]');
      const hasMain   = !!doc.querySelector('main,[role="main"]');
      const hasFooter = !!doc.querySelector('footer,[role="contentinfo"]');

      const missing = [];
      if (!hasHeader) missing.push('en-t√™te (<code>header</code> / <code>role="banner"</code>)');
      if (!hasNav)    missing.push('navigation (<code>nav</code> / <code>role="navigation"</code>)');
      if (!hasMain)   missing.push('contenu principal (<code>main</code> / <code>role="main"</code>)');
      if (!hasFooter) missing.push('pied de page (<code>footer</code> / <code>role="contentinfo"</code>)');

      if (missing.length === 0) {
        addRow(
          'Rep√®res de structure (landmarks)',
          'ok',
          'Les rep√®res principaux (header, nav, main, footer) sont pr√©sents.'
        );
      } else {
        addRow(
          'Rep√®res de structure (landmarks)',
          'warn',
          'Rep√®res manquants : ' + missing.join(', ') + '.'
        );
      }

      // Mise √† jour du tableau et des compteurs
      tbody.innerHTML = rows.join('');
      document.getElementById('count-ok').textContent   = ok;
      document.getElementById('count-warn').textContent = warn;
      document.getElementById('count-err').textContent  = err;

      target.textContent = 'Analyse termin√©e pour : ' + page + '.';
    }

    function hasLabel(doc, control) {
      const id = control.id;
      if (id) {
        const labelFor = doc.querySelector('label[for="' + CSS.escape(id) + '"]');
        if (labelFor) return true;
      }
      let parent = control.parentElement;
      while (parent) {
        if (parent.tagName && parent.tagName.toLowerCase() === 'label') return true;
        parent = parent.parentElement;
      }
      return false;
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;');
    }
  </script>
</body>
</html>
