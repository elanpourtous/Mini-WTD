<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Mini-assistant IA ‚Äì Mini-WTD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="description"
        content="Mini-assistant IA de Mini-WTD : prise de notes, lecture vocale (TTS) et dict√©e vocale (STT), pens√© pour les d√©monstrations d‚Äôaccessibilit√©.">

  <!-- Favicon & CSS globaux (adapt√©s au chemin depuis /ia/) -->
  <link rel="icon" href="../assets/img/logo-mini-wtd.png" type="image/png">
  <link rel="stylesheet" href="../assets/css/rgaa-accessible.css">
  <link rel="stylesheet" href="../assets/css/style.css">

  <style>
    :root{
      --bg:#050505;
      --bg-card:#151515;
      --border:#303030;
      --fg:#f7f7f7;
      --muted:#b3b3b3;
      --accent:#0b8457;
      --accent-soft:#123326;
      --danger:#ff6b6b;
      --radius:14px;
      --shadow:0 10px 30px rgba(0,0,0,.55);
    }

    body{
      margin:0;
      font-family:System,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--fg);
      line-height:1.6;
      font-size:1rem;
    }

    .skiplink{
      position:absolute;
      left:-9999px;
      top:0;
      padding:.6rem 1.2rem;
      background:#000;
      color:#fff;
      z-index:1000;
    }
    .skiplink:focus{
      left:.8rem;
      top:.8rem;
      outline:3px solid #fff;
    }

    main{
      max-width:960px;
      margin:0 auto;
      padding:1.2rem 1.2rem 1.8rem;
    }

    .page-header{
      margin-bottom:1.2rem;
    }
    .page-header h1{
      margin:.1rem 0 .3rem;
      font-size:1.5rem;
    }
    .page-header p{
      margin:0;
      color:var(--muted);
      font-size:.95rem;
    }

    .badge{
      display:inline-block;
      padding:.1rem .5rem;
      font-size:.75rem;
      border-radius:999px;
      background:#111;
      border:1px solid #333;
      color:#e7e7e7;
      margin-bottom:.25rem;
    }

    .layout{
      display:grid;
      grid-template-columns:minmax(0,3fr) minmax(0,2.4fr);
      gap:1rem;
    }
    @media (max-width:900px){
      .layout{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:var(--bg-card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:1rem 1rem 1rem;
      box-shadow:var(--shadow);
    }

    .card h2{
      margin-top:0;
      font-size:1.1rem;
      display:flex;
      align-items:center;
      gap:.5rem;
    }

    .emoji{
      font-size:1.4rem;
    }

    label{
      font-size:.9rem;
      font-weight:600;
      display:block;
      margin-bottom:.25rem;
    }
    textarea{
      width:100%;
      min-height:230px;
      resize:vertical;
      border-radius:10px;
      border:1px solid #333;
      padding:.7rem .8rem;
      background:#050505;
      color:var(--fg);
      font-family:inherit;
      line-height:1.5;
    }
    textarea:focus-visible{
      outline:2px solid var(--accent);
      outline-offset:2px;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:.5rem;
      margin-top:.5rem;
      align-items:center;
    }

    .btn{
      border-radius:999px;
      border:1px solid #666;
      padding:.35rem .9rem;
      font-size:.9rem;
      cursor:pointer;
      background:#111;
      color:#f0f0f0;
      display:inline-flex;
      align-items:center;
      gap:.35rem;
    }
    .btn-primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
      font-weight:600;
    }
    .btn-danger{
      border-color:var(--danger);
      color:#ffecec;
    }
    .btn[disabled]{
      opacity:.45;
      cursor:not-allowed;
    }
    .btn:focus-visible{
      outline:2px solid #fff;
      outline-offset:2px;
    }

    .hint{
      font-size:.8rem;
      color:var(--muted);
      margin-top:.15rem;
    }

    .kbd{
      display:inline-block;
      padding:.05rem .4rem;
      border-radius:4px;
      border:1px solid #555;
      background:#111;
      font-size:.8rem;
      font-family:monospace;
      color:#f7f7f7;
    }

    .panel{
      display:flex;
      flex-direction:column;
      gap:.6rem;
    }

    select,
    input[type="range"]{
      font-size:.9rem;
    }
    select{
      border-radius:999px;
      border:1px solid #444;
      padding:.25rem .7rem;
      background:#050505;
      color:#f7f7f7;
    }

    .inline-group{
      display:flex;
      flex-wrap:wrap;
      gap:.5rem;
      align-items:center;
      font-size:.85rem;
    }

    .status{
      font-size:.85rem;
      padding:.5rem .65rem;
      border-radius:10px;
      background:#0a0a0a;
      border:1px solid #333;
      min-height:2.2em;
    }
    .status--ok{ border-color:var(--accent); }
    .status--warn{ border-color:var(--danger); }

    .log{
      margin:0;
      padding-left:1.1rem;
      font-size:.85rem;
      max-height:190px;
      overflow:auto;
    }

    footer{
      margin-top:1rem;
      font-size:.75rem;
      color:var(--muted);
      text-align:left;
    }
  </style>
</head>

<body>
  <a href="#contenu" class="skiplink">Aller directement au mini-assistant</a>

  <main id="contenu" role="main" aria-labelledby="page-title">
    <header class="page-header">
      <span class="badge">Mini-WTD ¬∑ composant de d√©monstration</span>
      <h1 id="page-title">Mini-assistant IA accessible</h1>
      <p>
        Prise de notes simple, lecture vocale (TTS), dict√©e vocale (STT) quand le navigateur le permet.
        Pens√© pour les tests en formation et les d√©monstrations Work-Test-Demo.
      </p>
    </header>

    <section class="layout" aria-label="Assistant IA et contr√¥les">
      <!-- Bloc prise de notes -->
      <article class="card" aria-labelledby="notes-title">
        <h2 id="notes-title">
          <span class="emoji" aria-hidden="true">üìù</span>
          Zone de notes
        </h2>

        <label for="notes">Vos notes</label>
        <textarea id="notes" name="notes"
                  aria-describedby="notes-hint"
                  placeholder="√âcrivez ou dictez vos notes ici‚Ä¶"></textarea>
        <p id="notes-hint" class="hint">
          Astuce : vous pouvez faire lire cette zone avec la synth√®se vocale, ou la remplir avec la dict√©e si disponible.
        </p>

        <div class="btn-row" aria-label="Actions sur les notes">
          <button type="button" class="btn btn-primary" id="tts-read">
            üîä Lire les notes
          </button>
          <button type="button" class="btn" id="tts-stop">
            ‚èπ Arr√™ter la lecture
          </button>
          <button type="button" class="btn btn-danger" id="notes-clear">
            üßπ Effacer
          </button>
        </div>

        <p class="hint" aria-label="Raccourcis clavier synth√®se vocale">
          Raccourcis propos√©s : <span class="kbd">Ctrl</span> + <span class="kbd">Entr√©e</span> pour lancer la lecture,
          <span class="kbd">√âchap</span> pour arr√™ter (si support√©).
        </p>
      </article>

      <!-- Bloc TTS + STT -->
      <article class="card" aria-labelledby="speech-title">
        <h2 id="speech-title">
          <span class="emoji" aria-hidden="true">üß†</span>
          Voix & dict√©e (TTS / STT)
        </h2>

        <div class="panel" aria-label="Param√®tres de voix">
          <div class="inline-group">
            <label for="voice-select">Voix :</label>
            <select id="voice-select" name="voice-select" aria-label="Choix de la voix de synth√®se">
              <option value="">Par d√©faut (navigateur)</option>
            </select>
          </div>

          <div class="inline-group">
            <label for="rate">Vitesse :</label>
            <input id="rate" type="range" min="0.6" max="1.6" value="1" step="0.1">
            <span id="rate-val" aria-live="polite" aria-atomic="true">1.0√ó</span>
          </div>
        </div>

        <hr aria-hidden="true" style="border:none;border-top:1px solid #2a2a2a;margin:.7rem 0;">

        <div class="panel" aria-label="Dict√©e vocale (si disponible)">
          <div class="inline-group">
            <label for="lang">Langue de dict√©e :</label>
            <select id="lang" name="lang">
              <option value="fr-FR">Fran√ßais (France)</option>
              <option value="fr-CA">Fran√ßais (Canada)</option>
              <option value="en-US">Anglais (US)</option>
            </select>
          </div>

          <div class="btn-row" aria-label="Contr√¥les de dict√©e">
            <button type="button" class="btn" id="stt-start">
              üéôÔ∏è D√©marrer la dict√©e
            </button>
            <button type="button" class="btn" id="stt-stop">
              ‚èπ Arr√™ter la dict√©e
            </button>
          </div>

          <p class="hint">
            Si la dict√©e n‚Äôest pas disponible, un message vous l‚Äôindiquera.
            Raccourci possible : <span class="kbd">Ctrl</span> + <span class="kbd">Maj</span> + <span class="kbd">Entr√©e</span>.
          </p>

          <div class="status" id="stt-status" role="status" aria-live="polite">
            Dict√©e : en attente.
          </div>

          <details>
            <summary>Journal des transcriptions</summary>
            <ul class="log" id="stt-log"></ul>
          </details>
        </div>
      </article>
    </section>

    <footer>
      <p>
        Composant con√ßu comme support de <strong>d√©monstration</strong> pour Mini-WTD / Work-Test-Demo :
        on peut le casser, le tester, l‚Äôam√©liorer, avant d‚Äôint√©grer un outil IA r√©el dans une application m√©tier.
      </p>
    </footer>
  </main>

  <script>
    (function(){
      const notes      = document.getElementById('notes');
      const btnRead    = document.getElementById('tts-read');
      const btnStop    = document.getElementById('tts-stop');
      const btnClear   = document.getElementById('notes-clear');

      const rateInput  = document.getElementById('rate');
      const rateVal    = document.getElementById('rate-val');
      const voiceSelect= document.getElementById('voice-select');

      const sttStart   = document.getElementById('stt-start');
      const sttStop    = document.getElementById('stt-stop');
      const sttStatus  = document.getElementById('stt-status');
      const sttLog     = document.getElementById('stt-log');
      const langSelect = document.getElementById('lang');

      const synth = window.speechSynthesis;
      let currentUtterance = null;

      // --- Synth√®se vocale (TTS) ---
      function populateVoices(){
        if (!synth) return;
        const voices = synth.getVoices().filter(v => v.lang && v.lang.startsWith('fr'));
        voiceSelect.innerHTML = '<option value="">Par d√©faut (navigateur)</option>';
        voices.forEach((v, idx) => {
          const opt = document.createElement('option');
          opt.value = v.name;
          opt.textContent = `${v.name} (${v.lang})`;
          if (idx === 0) opt.selected = true;
          voiceSelect.appendChild(opt);
        });
      }
      if (synth){
        synth.onvoiceschanged = populateVoices;
        populateVoices();
      }

      function speakNotes(){
        if (!synth) return;
        const text = (notes.value || '').trim();
        if (!text) return;
        synth.cancel();
        const utt = new SpeechSynthesisUtterance(text);
        const rate = parseFloat(rateInput.value || '1');
        utt.rate = rate;
        const selectedName = voiceSelect.value;
        if (selectedName){
          const voices = synth.getVoices();
          const found = voices.find(v => v.name === selectedName);
          if (found) utt.voice = found;
        } else {
          utt.lang = 'fr-FR';
        }
        currentUtterance = utt;
        synth.speak(utt);
      }

      function stopSpeak(){
        if (synth && synth.speaking){
          synth.cancel();
        }
      }

      btnRead.addEventListener('click', speakNotes);
      btnStop.addEventListener('click', stopSpeak);
      btnClear.addEventListener('click', () => {
        notes.value = '';
        notes.focus();
      });

      rateInput.addEventListener('input', e => {
        const v = parseFloat(e.target.value || '1');
        rateVal.textContent = v.toFixed(1) + '√ó';
      });

      // --- Dict√©e vocale (STT) ---
      let Recognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
      let recog = null;
      let listening = false;

      function setStatus(text, mode){
        sttStatus.textContent = text;
        sttStatus.classList.remove('status--ok','status--warn');
        if (mode === 'ok') sttStatus.classList.add('status--ok');
        if (mode === 'warn') sttStatus.classList.add('status--warn');
      }

      if (!Recognition){
        sttStart.disabled = true;
        sttStop.disabled  = true;
        setStatus("Dict√©e vocale non disponible dans ce navigateur.", "warn");
      } else {
        recog = new Recognition();
        recog.continuous = true;
        recog.interimResults = true;

        recog.onstart = () => {
          listening = true;
          setStatus("Dict√©e en cours‚Ä¶ parlez pr√®s du micro.", "ok");
        };
        recog.onerror = (e) => {
          setStatus("Erreur dict√©e : " + e.error, "warn");
          listening = false;
        };
        recog.onend = () => {
          listening = false;
          if (!sttStatus.textContent.startsWith("Erreur")){
            setStatus("Dict√©e arr√™t√©e.", "ok");
          }
        };
        recog.onresult = (event) => {
          let finalTranscript = "";
          for (let i = event.resultIndex; i < event.results.length; i++){
            const res = event.results[i];
            if (res.isFinal){
              finalTranscript += res[0].transcript + " ";
            }
          }
          finalTranscript = finalTranscript.trim();
          if (finalTranscript){
            // Ajout dans la zone de notes
            const add = (notes.value ? notes.value + " " : "") + finalTranscript;
            notes.value = add.trim();

            // Log
            const li = document.createElement('li');
            li.textContent = finalTranscript;
            sttLog.appendChild(li);
          }
        };

        sttStart.addEventListener('click', () => {
          if (!recog || listening) return;
          try{
            recog.lang = langSelect.value || "fr-FR";
            recog.start();
          }catch(e){
            setStatus("Impossible de d√©marrer la dict√©e.", "warn");
          }
        });

        sttStop.addEventListener('click', () => {
          if (!recog || !listening) return;
          recog.stop();
        });
      }

      // Raccourcis clavier
      document.addEventListener('keydown', e => {
        // Ctrl + Entr√©e => lire les notes
        if (e.key === "Enter" && (e.ctrlKey || e.metaKey) && !e.shiftKey){
          e.preventDefault();
          speakNotes();
        }
        // Ctrl + Maj + Entr√©e => dict√©e start/stop (si dispo)
        if (e.key === "Enter" && (e.ctrlKey || e.metaKey) && e.shiftKey){
          if (!Recognition || !recog) return;
          e.preventDefault();
          if (!listening){
            sttStart.click();
          } else {
            sttStop.click();
          }
        }
        // √âchap => stop TTS
        if (e.key === "Escape"){
          stopSpeak();
        }
      });

      // Nettoyage synth√®se √† la fermeture
      window.addEventListener('beforeunload', stopSpeak);
    })();
  </script>
</body>
</html>
