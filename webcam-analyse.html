<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Mini-WTD ¬∑ Webcam & observation IA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description"
        content="Mini-WTD ‚Äî module webcam avec IA (MediaPipe Pose) : observation de posture et d‚Äôenvironnement, sans diagnostic m√©dical ni enregistrement d‚Äôimage.">

  <!-- Styles globaux Mini-WTD -->
  <link rel="stylesheet" href="assets/css/mini-wtd-2025.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="assets/css/base-a11y.css">
  <link rel="stylesheet" href="assets/css/rgaa-accessible.css">
</head>

<body>
<a href="#main" class="skiplink">Aller directement au contenu</a>

<!-- ===== HEADER ===== -->
<header class="site-header" role="banner">
  <div class="container site-header-inner">
    <div class="site-brand">
      <div class="site-logo">
        <img src="assets/ima/logo-mini-wtd-256.png" alt="Logo Mini-WTD" loading="lazy">
      </div>
      <div class="site-brand-text">
        <h1 class="site-title">Mini-WTD</h1>
        <p class="site-tagline">Work-Test-Demo ¬∑ Module webcam IA (d√©mo)</p>
      </div>
    </div>

    <div class="a11y-toolbar" aria-label="R√©glages d‚Äôaccessibilit√© et de lecture">
      <button class="access-btn" data-action="font-" type="button">A‚àí</button>
      <button class="access-btn" data-action="font+" type="button">A+</button>
      <button class="access-btn" data-action="contrast" type="button">‚óê</button>
      <button class="access-btn" data-action="spacing" type="button">‚ÜïÔ∏é</button>
      <button class="access-btn" data-action="reset" type="button">‚ü≤</button>
      <button id="theme-toggle" class="btn-icon" type="button">üåì</button>
      <button id="tts-toggle" class="btn-icon" type="button">üîä</button>
    </div>
  </div>

  <div class="container site-nav-toggle">
    <button
      id="menu-toggle"
      class="btn-icon"
      type="button"
      aria-label="Ouvrir ou fermer le menu"
      aria-expanded="false"
      aria-controls="primary-nav">
      <span class="burger" aria-hidden="true"></span>
      <span class="sr-only">Menu</span>
    </button>
  </div>

  <nav class="site-nav" aria-label="Navigation principale">
    <ul id="primary-nav">
      <li><a href="index.html">Accueil</a></li>
      <li><a href="presentation.html">Pr√©sentation</a></li>
      <li><a href="assistant.html">Assistant IA</a></li>
      <li><a href="evaluation-amenagement.html">Bilan</a></li>
      <li><a href="webcam-analyse.html" class="active" aria-current="page">Webcam IA</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
  </nav>
</header>

<!-- ===== CONTENU ===== -->
<main id="main" class="container" role="main" tabindex="-1">

  <!-- Hero -->
  <section class="hero">
    <h2>Module webcam ¬∑ observation ergonomique avec IA</h2>
    <p class="mwtd-lead">
      Ce module utilise <strong>MediaPipe Pose</strong> pour rep√©rer la position g√©n√©rale
      du corps et proposer un retour rapide sur la posture et l‚Äôenvironnement
      de travail. Il ne produit aucun diagnostic m√©dical et n‚Äôenregistre pas les images.
    </p>
    <p>
      Tout reste <strong>local dans le navigateur</strong> de l‚Äôordinateur utilis√©.
      Les r√©sultats sont des <strong>indications p√©dagogiques</strong> pour ouvrir le dialogue
      sur l‚Äôam√©nagement de poste (hauteur d‚Äô√©cran, distance, appuis, lumi√®re‚Ä¶).
    </p>
  </section>

  <!-- Ce que fait / ne fait pas -->
  <section class="cards-grid" aria-label="Limites et objectifs du module">
    <article class="card">
      <h3>Ce que fait ce module</h3>
      <ul>
        <li>Affiche la vid√©o de la webcam et un sch√©ma simplifi√© du corps.</li>
        <li>Estime la lumi√®re globale de la sc√®ne.</li>
        <li>Donne des messages sur la posture (buste pench√©, √©cran trop haut/bas‚Ä¶)</li>
        <li>Aide √† remplir le <a href="evaluation-amenagement.html">bilan d‚Äôam√©nagement</a>.</li>
      </ul>
    </article>

    <article class="card">
      <h3>Ce qu‚Äôil ne fait pas</h3>
      <ul>
        <li>Pas de diagnostic m√©dical ni d‚Äôavis d‚Äôaptitude.</li>
        <li>Pas de reconnaissance faciale ni d‚Äôidentification de personne.</li>
        <li>Pas d‚Äôenregistrement des images ni d‚Äôenvoi vers un serveur.</li>
        <li>Pas de d√©cision automatique sur le recrutement.</li>
      </ul>
    </article>
  </section>

  <!-- Bloc webcam + IA -->
  <section class="mwtd-panel" aria-labelledby="webcam-title">
    <header class="mwtd-card-header">
      <div>
        <h2 id="webcam-title" class="mwtd-card-title">Observation en direct via webcam</h2>
        <p class="mwtd-card-subtitle">
          Utilisation recommand√©e en <strong>pr√©sence de la personne</strong>, avec son accord explicite.
        </p>
      </div>
    </header>

    <div class="mwtd-grid" style="margin-top:1rem;">
      <!-- Colonne gauche : vid√©o + pose -->
      <div class="mwtd-card">
        <h3>Vue cam√©ra &amp; sch√©ma de posture</h3>
        <p class="form-hint">
          Cliquez sur <strong>‚ÄúActiver la webcam‚Äù</strong>, autorisez l‚Äôacc√®s √† la cam√©ra,
          puis laissez tourner quelques secondes pour que l‚ÄôIA se stabilise.
        </p>

        <div class="mwtd-webcam-shell">
          <div class="mwtd-webcam-video-wrap">
            <video id="mwtd-video"
                   playsinline
                   autoplay
                   muted
                   aria-label="Flux vid√©o de la webcam (aucun enregistrement)">
            </video>
            <!-- Canvas pour le squelette / analyse -->
            <canvas id="mwtd-pose-canvas"
                    aria-hidden="true"></canvas>

            <div id="mwtd-video-overlay" class="mwtd-webcam-overlay" aria-hidden="true">
              <p>En attente d‚Äôautorisation‚Ä¶</p>
            </div>
          </div>

          <div class="mwtd-row" style="margin-top:0.75rem;">
            <button id="mwtd-start" type="button" class="btn btn-primary">
              Activer la webcam IA
            </button>
            <button id="mwtd-stop" type="button" class="btn" disabled>
              Arr√™ter
            </button>
            <button id="mwtd-snapshot" type="button" class="btn" disabled>
              Refaire une analyse
            </button>
          </div>

          <p id="mwtd-webcam-status"
             class="form-hint"
             aria-live="polite"
             style="margin-top:0.5rem;">
            Statut : en attente.
          </p>

          <!-- Canvas cach√© pour la lumi√®re -->
          <canvas id="mwtd-light-canvas" width="320" height="240" hidden></canvas>
        </div>
      </div>

      <!-- Colonne droite : r√©sultats -->
      <div class="mwtd-card">
        <h3>Retour ergonomique (d√©mo)</h3>

        <dl class="mwtd-observe-list" aria-live="polite">
          <div class="mwtd-observe-item">
            <dt>Lumi√®re &amp; contraste</dt>
            <dd id="mwtd-result-light">En attente de flux cam√©ra.</dd>
          </div>
          <div class="mwtd-observe-item">
            <dt>Alignement buste / √©cran</dt>
            <dd id="mwtd-result-buste">En attente de d√©tection de posture.</dd>
          </div>
          <div class="mwtd-observe-item">
            <dt>Distance approximative</dt>
            <dd id="mwtd-result-distance">
              L‚ÄôIA estime la taille du buste dans l‚Äôimage et propose un rappel
              des bonnes pratiques (sans mesure exacte en centim√®tres).
            </dd>
          </div>
          <div class="mwtd-observe-item">
            <dt>Points de vigilance</dt>
            <dd id="mwtd-result-points">
              Observer les √©paules, la nuque, la rotation du tronc et la stabilit√© des appuis.
            </dd>
          </div>
        </dl>

        <div class="mwtd-observer-notes">
          <label for="mwtd-notes">
            Notes d‚Äôobservation (facultatif)
          </label>
          <textarea id="mwtd-notes" rows="4"
                    placeholder="Exemples : buste tr√®s pench√© en avant, lumi√®re venant de l‚Äôarri√®re, besoin d‚Äôun support pour l‚Äôavant-bras‚Ä¶"></textarea>
          <p class="form-hint">
            Vous pouvez copier-coller ces notes dans le bilan d‚Äôam√©nagement.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Mode d‚Äôemploi -->
  <section class="mwtd-panel" aria-labelledby="mode-usage-title">
    <header class="mwtd-card-header">
      <div>
        <h2 id="mode-usage-title" class="mwtd-card-title">Usage recommand√© en entretien</h2>
        <p class="mwtd-card-subtitle">
          L‚ÄôIA sert d‚Äô<strong>outil de discussion</strong>, pas de verdict.
        </p>
      </div>
    </header>

    <ol class="mwtd-list-steps">
      <li>Expliquer le but : am√©liorer le poste, pas juger la personne.</li>
      <li>Demander l‚Äôaccord clair avant d‚Äôactiver la webcam.</li>
      <li>Positionner la cam√©ra pour voir le buste et l‚Äô√©cran sans d√©voiler d‚Äô√©l√©ments priv√©s inutiles.</li>
      <li>Lire ensemble les retours (lumi√®re, buste, distance) et demander le ressenti de la personne.</li>
      <li>Reporter dans le <a href="evaluation-amenagement.html">bilan d‚Äôam√©nagement</a> les pistes d‚Äôaction concr√®tes.</li>
    </ol>

    <p class="form-hint">
      Toute d√©cision doit rester <strong>humaine</strong> et concert√©e.  
      L‚ÄôIA n‚Äôest qu‚Äôun rep√®re visuel et textuel pour mieux comprendre la situation.
    </p>
  </section>
</main>

<!-- ===== FOOTER ===== -->
<footer class="site-footer" role="contentinfo">
  <div class="container">
    <p>¬© 2025 ¬∑ Mini-WTD ‚Äî Module webcam IA de d√©monstration, sans enregistrement d‚Äôimages.</p>
  </div>
</footer>

<!-- ===== Librairies MediaPipe (IA locale dans le navigateur) ===== -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

<!-- ===== Script IA Mini-WTD ===== -->
<script>
(function () {
  const video        = document.getElementById('mwtd-video');
  const canvasPose   = document.getElementById('mwtd-pose-canvas');
  const ctxPose      = canvasPose.getContext('2d');
  const canvasLight  = document.getElementById('mwtd-light-canvas');
  const ctxLight     = canvasLight.getContext('2d');
  const overlay      = document.getElementById('mwtd-video-overlay');

  const btnStart     = document.getElementById('mwtd-start');
  const btnStop      = document.getElementById('mwtd-stop');
  const btnSnapshot  = document.getElementById('mwtd-snapshot');
  const statusEl     = document.getElementById('mwtd-webcam-status');

  const lightEl      = document.getElementById('mwtd-result-light');
  const busteEl      = document.getElementById('mwtd-result-buste');
  const distanceEl   = document.getElementById('mwtd-result-distance');
  const pointsEl     = document.getElementById('mwtd-result-points');

  let camera = null;
  let lastLandmarks = null;

  function setStatus(text) {
    if (statusEl) statusEl.textContent = 'Statut : ' + text;
  }

  // --- Analyse simple de la lumi√®re ---
  function analyseLuminosite() {
    if (!video.videoWidth || !video.videoHeight) return;

    const w = canvasLight.width;
    const h = canvasLight.height;
    ctxLight.drawImage(video, 0, 0, w, h);
    const data = ctxLight.getImageData(0, 0, w, h).data;

    let sum = 0;
    for (let i = 0; i < data.length; i += 4) {
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];
      const lum = 0.299 * r + 0.587 * g + 0.114 * b;
      sum += lum;
    }
    const avg = sum / (data.length / 4);

    let msg;
    if (avg < 60) {
      msg = "√âclairage tr√®s faible : risque de fatigue visuelle, ajouter une lumi√®re douce orient√©e vers le plan de travail.";
    } else if (avg < 120) {
      msg = "√âclairage plut√¥t faible : v√©rifier que le visage et le clavier sont bien visibles.";
    } else if (avg > 210) {
      msg = "√âclairage tr√®s fort : attention aux reflets et √† l‚Äô√©blouissement sur l‚Äô√©cran.";
    } else {
      msg = "√âclairage globalement correct (√† valider avec la personne).";
    }
    lightEl.textContent = msg;
  }

  // --- Utilitaires pour la posture ---
  function getPoint(landmarks, index) {
    return landmarks && landmarks[index] ? landmarks[index] : null;
  }

  function distance(a, b) {
    if (!a || !b) return null;
    const dx = a.x - b.x;
    const dy = a.y - b.y;
    return Math.sqrt(dx * dx + dy * dy);
  }

  function analysePosture(landmarks) {
    if (!landmarks || landmarks.length === 0) {
      busteEl.textContent = "Aucune posture d√©tect√©e. Demander √† la personne de se placer face √† la cam√©ra.";
      pointsEl.textContent = "Impossible d‚Äô√©valuer les appuis et la rotation du tronc sans d√©tection du corps.";
      return;
    }

    lastLandmarks = landmarks;

    // Indices principaux MediaPipe Pose
    const nose     = getPoint(landmarks, 0);
    const leftShoulder  = getPoint(landmarks, 11);
    const rightShoulder = getPoint(landmarks, 12);
    const leftHip       = getPoint(landmarks, 23);
    const rightHip      = getPoint(landmarks, 24);

    // Centre √©paules / hanches
    let msgBuste = "";
    let msgPoints = [];

    if (leftShoulder && rightShoulder) {
      const midShoulderX = (leftShoulder.x + rightShoulder.x) / 2;
      const diffShoulderY = Math.abs(leftShoulder.y - rightShoulder.y);

      if (diffShoulderY > 0.05) {
        msgPoints.push("√âpaules visiblement d√©salign√©es : possible inclinaison lat√©rale du buste.");
      }

      if (nose) {
        const decalage = Math.abs(nose.x - midShoulderX);
        if (decalage > 0.08) {
          msgBuste = "Buste et t√™te plut√¥t inclin√©s sur le c√¥t√©. V√©rifier la hauteur et la position de l‚Äô√©cran.";
        }
      }
    }

    if (leftShoulder && rightShoulder && leftHip && rightHip) {
      const midShoulderY = (leftShoulder.y + rightShoulder.y) / 2;
      const midHipY      = (leftHip.y + rightHip.y) / 2;
      const vertical = midHipY - midShoulderY;

      if (vertical < 0.20) {
        msgBuste = "Buste tr√®s proche de la cam√©ra : la personne semble pench√©e en avant. Proposer un recul de la chaise ou de l‚Äô√©cran.";
      } else if (!msgBuste) {
        msgBuste = "Alignement buste/√©cran relativement neutre. Confirmer avec la personne si la position reste confortable dans la dur√©e.";
      }
    } else if (!msgBuste) {
      msgBuste = "Buste partiellement d√©tect√©. Utiliser l‚Äôobservation humaine pour compl√©ter.";
    }

    // Estimation tr√®s grossi√®re de la distance : taille du buste √† l‚Äôimage
    let msgDistance = distanceEl.textContent;
    if (leftShoulder && rightShoulder && leftHip && rightHip) {
      const torsoHeight = distance(
        {x: (leftShoulder.x + rightShoulder.x) / 2, y: (leftShoulder.y + rightShoulder.y) / 2},
        {x: (leftHip.x + rightHip.x) / 2, y: (leftHip.y + rightHip.y) / 2}
      );
      if (torsoHeight) {
        if (torsoHeight > 0.55) {
          msgDistance = "La cam√©ra est tr√®s proche du buste : l‚Äô√©cran semble tr√®s proche du visage. Proposer un l√©ger recul si possible.";
        } else if (torsoHeight < 0.30) {
          msgDistance = "La personne appara√Æt assez loin. V√©rifier que les caract√®res √† l‚Äô√©cran restent lisibles sans effort.";
        } else {
          msgDistance = "Distance apparente correcte, √† confirmer avec la personne (lisibilit√©, confort visuel).";
        }
      }
    }

    if (msgPoints.length === 0) {
      msgPoints.push("Surveiller la fatigue de la nuque et des √©paules sur la dur√©e, m√™me en posture neutre.");
    }

    busteEl.textContent    = msgBuste;
    distanceEl.textContent = msgDistance;
    pointsEl.textContent   = msgPoints.join(" ");
  }

  // --- Callback MediaPipe Pose ---
  function onResults(results) {
    if (!video.videoWidth || !video.videoHeight) return;

    canvasPose.width  = video.videoWidth;
    canvasPose.height = video.videoHeight;

    ctxPose.save();
    ctxPose.clearRect(0, 0, canvasPose.width, canvasPose.height);

    // On redessine l‚Äôimage + squelette (d√©mo visuelle)
    ctxPose.drawImage(
      results.image,
      0, 0,
      canvasPose.width, canvasPose.height
    );

    if (results.poseLandmarks && results.poseLandmarks.length > 0) {
      drawConnectors(ctxPose, results.poseLandmarks, POSE_CONNECTIONS);
      drawLandmarks(ctxPose, results.poseLandmarks);
      analysePosture(results.poseLandmarks);
    } else {
      analysePosture(null);
    }

    ctxPose.restore();
    analyseLuminosite();
    if (overlay) overlay.innerHTML = "<p>Webcam IA active (d√©mo).</p>";
  }

  // --- Initialisation de MediaPipe Pose ---
  const pose = new Pose.Pose({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
  });

  pose.setOptions({
    modelComplexity: 1,
    smoothLandmarks: true,
    enableSegmentation: false,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  pose.onResults(onResults);

  async function startCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      setStatus("webcam non support√©e par ce navigateur.");
      return;
    }

    try {
      camera = new Camera.Camera(video, {
        onFrame: async () => {
          await pose.send({ image: video });
        },
        width: 640,
        height: 480
      });
      await camera.start();

      if (btnStop) btnStop.disabled = false;
      if (btnSnapshot) btnSnapshot.disabled = false;

      setStatus("webcam IA en cours d‚Äôanalyse.");
    } catch (err) {
      console.error(err);
      setStatus("acc√®s refus√© ou impossible.");
      if (overlay) overlay.innerHTML =
        "<p>Acc√®s √† la webcam refus√© ou impossible.</p>";
    }
  }

  function stopCamera() {
    if (camera) {
      camera.stop();
      camera = null;
    }
    video.srcObject = null;
    ctxPose.clearRect(0, 0, canvasPose.width, canvasPose.height);
    if (overlay) overlay.innerHTML = "<p>Webcam arr√™t√©e.</p>";
    if (btnStop) btnStop.disabled = true;
    if (btnSnapshot) btnSnapshot.disabled = true;
    setStatus("webcam arr√™t√©e.");
  }

  // ‚ÄúRefaire une analyse‚Äù = juste forcer un texte rappel
  function snapshotAnalyse() {
    if (!lastLandmarks) {
      setStatus("aucune posture m√©moris√©e pour l‚Äôinstant.");
      return;
    }
    analysePosture(lastLandmarks);
    analyseLuminosite();
    setStatus("analyse actualis√©e.");
  }

  if (btnStart)   btnStart.addEventListener('click', startCamera);
  if (btnStop)    btnStop.addEventListener('click', stopCamera);
  if (btnSnapshot) btnSnapshot.addEventListener('click', snapshotAnalyse);

  window.addEventListener('beforeunload', stopCamera);
})();
</script>

<!-- Scripts d‚Äôaccessibilit√© Mini-WTD -->
<script src="assets/js/mwtd-menu.js"></script>
<script src="assets/js/mwtd-accessibility.js"></script>
<script src="assets/js/mwtd-theme.js"></script>
<script src="assets/js/mwtd-tts.js"></script>

</body>
</html>
